# See https://github.com/uselagoon/lagoon-images/blob/main/images/nginx/helpers/100_x-robots-header-development.conf
header_filter_by_lua_block {
  -- Set X-Robots-Tag to 'noindex, nofollow' for development environments and Lagoon autogenerated routes
  -- escape characters in the hostname
  local host = string.gsub(ngx.var.host, "%p", "%%%1")

  -- check to see if we are a development environment
  if (os.getenv("LAGOON_ENVIRONMENT_TYPE") and string.match(os.getenv("LAGOON_ENVIRONMENT_TYPE"), 'development')) then
    ngx.header["X-Robots-Tag"] = 'noindex, nofollow';
  end

  -- check hostname against autogenerated routes
  if (os.getenv("LAGOON_AUTOGENERATED_ROUTES") and string.match(os.getenv("LAGOON_AUTOGENERATED_ROUTES"), host.."$")) then
    ngx.header["X-Robots-Tag"] = 'noindex, nofollow';
  end

  -- GOVCMS-1331: Peripheral pages are not protected again framing attacks
  local xframeoptions = ngx.resp.get_headers()["x-frame-options"];
  if (xframeoptions == nil or xframeoptions == '') then
    ngx.header["X-Frame-Options"] = "${X_FRAME_OPTIONS:-SAMEORIGIN}";
  end
}
